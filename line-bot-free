const express = require('express');
const line = require('@line/bot-sdk');
const cron = require('node-cron');

// LINE Botè¨­å®š
const config = {
  channelAccessToken: 'YOUR_CHANNEL_ACCESS_TOKEN', // LINE Developersã‹ã‚‰å–å¾—
  channelSecret: 'YOUR_CHANNEL_SECRET' // LINE Developersã‹ã‚‰å–å¾—
};

const client = new line.Client(config);
const app = express();

// Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®š
app.post('/webhook', line.middleware(config), (req, res) => {
  Promise
    .all(req.body.events.map(handleEvent))
    .then((result) => res.json(result))
    .catch((err) => {
      console.error(err);
      res.status(500).end();
    });
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–¢æ•°
async function handleEvent(event) {
  if (event.type !== 'message' || event.message.type !== 'text') {
    return Promise.resolve(null);
  }

  const userMessage = event.message.text;
  const userId = event.source.userId;
  
  let replyMessage = generateResponse(userMessage);
  
  // ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®åˆ†å²å‡¦ç†
  if (userMessage.includes('å¤©æ°—')) {
    replyMessage = {
      type: 'text',
      text: 'ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ï¼â˜€ï¸\nå¤–å‡ºæ—¥å’Œã§ã™ã€‚æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ï¼'
    };
  } else if (userMessage.includes('æ™‚é–“') || userMessage.includes('ä½•æ™‚')) {
    const now = new Date();
    const timeStr = now.toLocaleString('ja-JP', {
      timeZone: 'Asia/Tokyo',
      hour: '2-digit',
      minute: '2-digit',
      month: 'short',
      day: 'numeric'
    });
    replyMessage = {
      type: 'text',
      text: `ç¾åœ¨ã®æ™‚åˆ»ã¯${timeStr}ã§ã™â°`
    };
  } else if (userMessage.includes('ãŠã¯ã‚ˆã†')) {
    replyMessage = {
      type: 'text',
      text: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ğŸŒ…\nä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼\n\nä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚å£°ã‚’ã‹ã‘ã¦ãã ã•ã„ã­ã€‚'
    };
  } else if (userMessage.includes('ãŠã‚„ã™ã¿')) {
    replyMessage = {
      type: 'text',
      text: 'ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ğŸŒ™\nã‚†ã£ãã‚Šä¼‘ã‚“ã§ã€ã¾ãŸæ˜æ—¥ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚\nãŠã‚„ã™ã¿ãªã•ã„ğŸ’¤'
    };
  }

  return client.replyMessage(event.replyToken, replyMessage);
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
function generateResponse(userMessage) {
  const responses = [
    'ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ“±\næ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚',
    'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼\nãŠè¿”äº‹ã‚’ãŠå¾…ã¡ãã ã•ã„âœ¨',
    'ã„ã¤ã‚‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ™\nç¢ºèªã„ãŸã—ã¾ã™ã€‚',
    'ãŠç–²ã‚Œã•ã¾ã§ã™ï¼\nå†…å®¹ã‚’ç¢ºèªã•ã›ã¦ã„ãŸã ãã¾ã™ã­ã€‚'
  ];
  
  return {
    type: 'text',
    text: responses[Math.floor(Math.random() * responses.length)]
  };
}

// ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
async function sendPushMessage(userId, message) {
  try {
    await client.pushMessage(userId, message);
    console.log('ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†:', new Date());
  } catch (error) {
    console.error('ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ä¸€æ–‰é€ä¿¡
async function broadcastMessage(message) {
  try {
    await client.broadcast(message);
    console.log('ä¸€æ–‰é€ä¿¡å®Œäº†:', new Date());
  } catch (error) {
    console.error('ä¸€æ–‰é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š

// æ¯æœ8æ™‚ã«æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
cron.schedule('0 8 * * *', async () => {
  const morningMessage = {
    type: 'text',
    text: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ğŸŒ…\n\nä»Šæ—¥ã‚‚ç´ æ•µãªä¸€æ—¥ã‚’ãŠéã”ã—ãã ã•ã„ã€‚\nä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ãŠå£°ãŒã‘ãã ã•ã„ï¼'
  };
  
  await broadcastMessage(morningMessage);
}, {
  timezone: "Asia/Tokyo"
});

// æ¯é€±æœˆæ›œæ—¥9æ™‚ã«é€±å§‹ã‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
cron.schedule('0 9 * * 1', async () => {
  const mondayMessage = {
    type: 'text',
    text: 'æ–°ã—ã„é€±ã®å§‹ã¾ã‚Šã§ã™ï¼ğŸ’ª\n\nä»Šé€±ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\nçš†ã•ã¾ã«ã¨ã£ã¦å®Ÿã‚Šå¤šã„ä¸€é€±é–“ã¨ãªã‚Šã¾ã™ã‚ˆã†ã«âœ¨'
  };
  
  await broadcastMessage(mondayMessage);
}, {
  timezone: "Asia/Tokyo"
});

// æ¯æœˆ1æ—¥10æ™‚ã«ãŠçŸ¥ã‚‰ã›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
cron.schedule('0 10 1 * *', async () => {
  const monthlyMessage = {
    type: 'text',
    text: 'ğŸ“… æ–°ã—ã„æœˆãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼\n\nä»Šæœˆã®ãŠå¾—æƒ…å ±ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãŠæ¥½ã—ã¿ã«ğŸ‰\nä½•ã‹ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
  };
  
  await broadcastMessage(monthlyMessage);
}, {
  timezone: "Asia/Tokyo"
});

// ç‰¹åˆ¥ãªã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ï¼ˆä¾‹ï¼šé‡‘æ›œæ—¥ã®å¤•æ–¹ï¼‰
cron.schedule('0 17 * * 5', async () => {
  const fridayMessage = {
    type: 'text',
    text: 'é‡‘æ›œæ—¥ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ğŸ‰\n\nç´ æ•µãªé€±æœ«ã‚’ãŠéã”ã—ãã ã•ã„ã€‚\nã¾ãŸæ¥é€±ã€ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ï¼'
  };
  
  await broadcastMessage(fridayMessage);
}, {
  timezone: "Asia/Tokyo"
});

// ãƒªãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¾‹
async function sendRichMessage(userId) {
  const flexMessage = {
    type: 'flex',
    altText: 'ãŠçŸ¥ã‚‰ã›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
    contents: {
      type: 'bubble',
      hero: {
        type: 'image',
        url: 'https://example.com/image.jpg', // å®Ÿéš›ã®ç”»åƒURLã«å¤‰æ›´
        size: 'full',
        aspectRatio: '20:13',
        aspectMode: 'cover'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'ç‰¹åˆ¥ãªãŠçŸ¥ã‚‰ã›',
            weight: 'bold',
            size: 'xl'
          },
          {
            type: 'text',
            text: 'æ–°ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼',
            size: 'md',
            color: '#666666',
            margin: 'md'
          }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            action: {
              type: 'uri',
              label: 'è©³ç´°ã‚’è¦‹ã‚‹',
              uri: 'https://example.com' // å®Ÿéš›ã®URLã«å¤‰æ›´
            }
          }
        ]
      }
    }
  };

  await client.pushMessage(userId, flexMessage);
}

// æ‰‹å‹•ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
async function sendTestMessage() {
  const testUserId = 'USER_ID_HERE'; // å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«å¤‰æ›´
  
  const testMessage = {
    type: 'text',
    text: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ğŸ§ª\n\nBotãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚'
  };
  
  await sendPushMessage(testUserId, testMessage);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
const userProfiles = new Map();

function saveUserProfile(userId, profile) {
  userProfiles.set(userId, {
    ...profile,
    lastActive: new Date()
  });
}

function getUserProfile(userId) {
  return userProfiles.get(userId);
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
cron.schedule('0 12 * * *', async () => {
  // éå»7æ—¥ä»¥å†…ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®š
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  
  const lunchMessage = {
    type: 'text',
    text: 'ãŠæ˜¼ã®æ™‚é–“ã§ã™ã­ğŸ±\n\nãƒ©ãƒ³ãƒã¯ãŠæ¸ˆã¿ã§ã™ã‹ï¼Ÿ\nåˆå¾Œã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼'
  };
  
  // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
  console.log('æ˜¼é£Ÿæ™‚é–“ã®æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æº–å‚™ä¸­...');
  // await broadcastMessage(lunchMessage);
}, {
  timezone: "Asia/Tokyo"
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`LINE Bot ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ${port}ã§èµ·å‹•ã—ã¾ã—ãŸ`);
  console.log('å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:');
  console.log('- æ¯æœ8æ™‚: æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸');
  console.log('- æ¯é€±æœˆæ›œ9æ™‚: é€±å§‹ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸');
  console.log('- æ¯æœˆ1æ—¥10æ™‚: æœˆå§‹ã‚ãŠçŸ¥ã‚‰ã›');
  console.log('- æ¯é€±é‡‘æ›œ17æ™‚: é€±æœ«ã®æŒ¨æ‹¶');
  console.log('- æ¯æ—¥12æ™‚: ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ æŒ¨æ‹¶');
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
process.on('unhandledRejection', (reason, promise) => {
  console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', promise, 'reason:', reason);
});

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
console.log(`
=== LINE Bot ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é † ===

1. LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ
   https://developers.line.biz/ja/

2. ç’°å¢ƒå¤‰æ•°è¨­å®š:
   export CHANNEL_ACCESS_TOKEN="your_token_here"
   export CHANNEL_SECRET="your_secret_here"

3. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
   npm install express @line/bot-sdk node-cron

4. Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®š:
   https://yourdomain.com/webhook

5. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•:
   node app.js

=== æ©Ÿèƒ½ä¸€è¦§ ===
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®è‡ªå‹•å¿œç­”
âœ… å®šæœŸçš„ãªæŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆ†å²å‡¦ç†
âœ… ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
âœ… ãƒªãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µãƒ³ãƒ—ãƒ«
`);

module.exports = { app, client, sendPushMessage, broadcastMessage };
